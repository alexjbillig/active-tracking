<!DOCTYPE html>
<html>
<head>
  <title>Two tracks</title>
  <link href="jsPsych-master/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>

<body>

<button id="loadButton">Load</button>
<button id="startButton">Start</button>

<script type="text/javascript">

// stimulus array
const stimuli = ["audio/1_001.wav", "audio/1_002.wav"]

// empty track array
const track = new Array(2)

// create audio context
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;

// startbutton
const startButton = document.querySelector('#startButton');

// function for fetching the audio file and decoding the data
async function getFile(filepath) {
  const response = await fetch(filepath);
  const arrayBuffer = await response.arrayBuffer();
  const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
  return audioBuffer;
}

// function to call each file and return an array of decoded files
async function loadFile(filePath) {
  const track = await getFile(filePath);
  return track;
}

let offset = 0;
// create buffer, insert data, connect, and play
function playTrack(audioBuffer) {
  const trackSource = audioCtx.createBufferSource();
  trackSource.buffer = audioBuffer;
  trackSource.connect(audioCtx.destination)

  if (offset == 0) {
    trackSource.start();
    offset = audioCtx.currentTime;
  } else {
    trackSource.start(0, audioCtx.currentTime - offset);
  }

  return trackSource;
}

loadButton.addEventListener('click', () => {
  if (audioCtx != null) {
    return;
  }

  audioCtx = new AudioContext();

  document.querySelector("#loadButton").hidden = true;

  stimuli.forEach((thisStimulus, i) => {

    // load file
    track[i] = loadFile(thisStimulus)
  })
});

startButton.addEventListener('click', () => {

    // check if context is in suspended state (autoplay policy)
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }

    track.forEach((thisTrack, i) => {
    playTrack(thisTrack);
    })
  })





</script>

</body>
</html>
