<!DOCTYPE html>
<html>
<title>Density testing</title>
<link href="jsPsych-master/css/jspsych.css" rel="stylesheet" type="text/css"></link>
<body>

  <button id="startButton">Start</button>
  <button onclick="decreaseDensity()">Decrease</button>
  <button onclick="increaseDensity()">Increase</button>

  <p id="densityDisplay"></p>
  <p id="volumeDisplay"></p>

  <script>

  // should only allow density changes once sounds have started

  // adjustments currently generate clicks. might be different when sounds are
  // slower, as they are for active tracking. but if not, adjustments should
  // apply during the silent 10-ms periods

  // during development should be able to specify/select sound files from site

  // list of audio files
  //const audioList = ["audio/1_001.wav", "audio/1_002.wav", "audio/1_003.wav",
  //"audio/1_004.wav", "audio/1_005.wav", "audio/1_006.wav", "audio/1_007.wav",
  //"audio/1_008.wav", "audio/1_009.wav", "audio/1_010.wav"];

  const audioList = ["audio/1_001.wav", "audio/1_01norm.wav"];

  // get start button
  const startButton = document.querySelector('#startButton')

  // track, volume, and density settings
  const numTracks = audioList.length;
  const maxVolume = 1;
  const maxDensity = numTracks;
  const minDensity = 0;

  // get audio context
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;

  // initialise density
  var currentDensity = 1;
  document.getElementById('densityDisplay').innerHTML = "Density: " + currentDensity;

  // initialise volumes
  var volumes = [];
  updateVolumes();

  // initialise trackSource and gainnode
  var trackSource = [];
  var gainNode = [];

  // functions

  // function for fetching the audio file and decode the data
  async function getFile(filepath) {
    const response = await fetch(filepath);
    const arrayBuffer = await response.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    return audioBuffer;
  }

  // function to call each file and return an array of decoded files
  async function loadFile(filePath) {
    const track = await getFile(filePath);
    return track;
  }

  let offset = 0;
  // create a buffer, plop in data, connect and play
  // should be able to set this to delay a bit so that function can be called
  // multiple times before sound needs to start
  // also need to add the gain node / volume manipulation - can I still do this
  // when the buffers/sources are within the playTrack function?
  // allow to be called with track number, so will change trackSource into e.g.
  // an array

  function playTrack(audioBuffer, i) {
  //function playTrack(audioBuffer) {
    trackSource[i] = audioCtx.createBufferSource();
    trackSource[i].buffer = audioBuffer;
    gainNode[i] = audioCtx.createGain();
    gainNode[i].gain.value = volumes[i];
    trackSource[i].connect(gainNode[i]).connect(audioCtx.destination)

    if (offset == 0) {
      trackSource[i].start();
      offset = audioCtx.currentTime;
    } else {
      trackSource[i].start(0, audioCtx.currentTime - offset);
    }

    return trackSource;
  }

  // would like this to remain but be inaccesisble
  startButton.addEventListener('click', () => {
    if (audioCtx != null) {
      return;
    }

    audioCtx = new AudioContext();

    // hide start button
    document.querySelector("#startButton").hidden = true;

    // iterate through audio files
    audioList.forEach((element, i) => {

      // load file
      loadFile(element).then((track) => {

        // check if context is in suspended state (autoplay policy)
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }

        // play track
        playTrack(track, i);

      })
    })
  });

  function increaseDensity() {
    currentDensity = Math.min(currentDensity + 1, maxDensity);
    document.getElementById('densityDisplay').innerHTML = "Density: " + currentDensity;
    updateVolumes();
    updateGainNodes();
  }

  function decreaseDensity() {
    currentDensity = Math.max(currentDensity -1, minDensity);
    document.getElementById('densityDisplay').innerHTML = "Density: " + currentDensity;
    updateVolumes();
    updateGainNodes();
  }

  function updateVolumes() {
    if (currentDensity == 0) {
      for (i = 0; i < numTracks; i++) {
        volumes[i] = 0;
      }
    }
    else {
      for (i = 0; i < currentDensity; i++) {
        volumes[i] = maxVolume/currentDensity;
      }
      for (i = currentDensity; i < numTracks; i++){
        volumes[i] = 0;
      }
    }
    document.getElementById('volumeDisplay').innerHTML = "Volumes: " + volumes;
  };

  function updateGainNodes() {
    for (i = 0; i < numTracks; i++) {
      gainNode[i].gain.value = volumes[i];
    }
  };

  </script>

</body>
</html>
