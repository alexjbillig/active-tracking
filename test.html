<!DOCTYPE html>
<html>
<title>Density testing</title>
<link href="jsPsych-master/css/jspsych.css" rel="stylesheet" type="text/css"></link>
<body>

  <audio src = "audio/1_001.wav"></audio>

  <button data-playing="false" onclick="startStop()">Start</button>
  <button onclick="decreaseDensity()">Decrease</button>
  <button onclick="increaseDensity()">Increase</button>

  <p id="densityDisplay"></p>
  <p id="volumeDisplay"></p>

  <script>

  // track, volume, and density settings
  const numTracks = 2;
  const maxVolume = 1;
  const maxDensity = numTracks;
  const minDensity = 0;

  // list of audio files
  //const audioList = ["audio/1_001.wav", "audio/1_002.wav"];

  // get audio context
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const audioContext = new AudioContext();

  //var track = [];
  //var gainNode = [];

  // get the audio element
  const audioElement = document.querySelector('audio');

  // pass it into the audio context
  const track = audioContext.createMediaElementSource(audioElement);

  // gainnode
  const gainNode = audioContext.createGain();

  const volumeControl = document.querySelector('#volume');

  volumeControl.addEventListener('input', function() {
    gainNode.gain.value = this.value;
  }, false);

  // connect to output
  track.connect(gainNode).connect(audioContext.destination);

  // connect to output
  //track.connect(gainNode).connect(audioContext.destination);


  //for (i = 0; i < numTracks; i++) {

    // pass it into the audio context
    //track[i] = audioContext.createMediaElementSource(audioList[i]);

    // gainnode
    //gainNode[i] = audioContext.createGain();

    // connect to output
    //track[i].connect(gainNode[i]).connect(audioContext.destination);

  //}

  // initialise density
  var currentDensity = 1;
  document.getElementById('densityDisplay').innerHTML = "Density: " + currentDensity;

  // initialise volumes
  var volumes = [];
  updateVolumes();

  // play
  //audioList[i].play();

  // functions

  function startStop() {
    // check if context is in suspended state (autoplay policy)
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }

    // play or pause track depending on state
    if (this.dataset.playing === 'false') {
        audioElement.play();
        this.dataset.playing = 'true';
    } else if (this.dataset.playing === 'true') {
        audioElement.pause();
        this.dataset.playing = 'false';
    }
  }

  function increaseDensity() {
    currentDensity = Math.min(currentDensity + 1, maxDensity);
    document.getElementById('densityDisplay').innerHTML = "Density: " + currentDensity;
    updateVolumes();
  }

  function decreaseDensity() {
    currentDensity = Math.max(currentDensity -1, minDensity);
    document.getElementById('densityDisplay').innerHTML = "Density: " + currentDensity;
    updateVolumes();
  }

  function updateVolumes() {
    if (currentDensity == 0) {
      for (i = 0; i < numTracks; i++) {
        volumes[i] = 0;
        gainNode[i].gain.value = volumes[i];
      }
    }
    else {
      for (i = 0; i < currentDensity; i++) {
        volumes[i] = maxVolume/currentDensity;
        gainNode[i].gain.value = volumes[i];
      }
      for (i = currentDensity; i < numTracks; i++){
        volumes[i] = 0;
        gainNode[i].gain.value = volumes[i];
      }
    }
    document.getElementById('volumeDisplay').innerHTML = "Volumes: " + volumes;

  };

  </script>

</body>
</html>
